<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam DEX</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<!-- Library for encryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  :root{
    --bg1:#1a2a6c; --bg2:#b21f1f; --bg3:#fdbb2d;
    --card:rgba(0, 0, 0, 0.2); --card2:rgba(0, 0, 0, 0.3);
    --text:#f0f4f8; --muted:#a0b0c0;
    --brand:#ffc300; --brand2:#ffd60a; --line:rgba(255, 255, 255, 0.2);
    --ok:#28a745; --warn:#ffc107; --err:#dc3545;
    --maxw: 920px; --rad:14px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    color:var(--text);
    background: linear-gradient(135deg, var(--bg1), var(--bg2), var(--bg3));
    min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:24px 14px;
  }
  .app{ width:100%; max-width:var(--maxw); text-align:center; }
  h1{
    margin:0 0 18px 0; font-size:2.2rem; font-weight:800; color:var(--brand);
    text-shadow:0 0 12px rgba(255,195,0,.7);
  }
  .card{
    background: var(--card);
    border:1px solid rgba(255,255,255,.1);
    border-radius: var(--rad);
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0,0,0,.25);
    padding:18px;
    margin:14px auto;
  }
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  @media (max-width:820px){ .grid-2{ grid-template-columns:1fr; } }

  label{ display:block; text-align:left; margin:6px 0 6px; font-weight:600; color:var(--brand); }
  input, select, button{
    width:100%; padding:12px 14px; border:none; border-radius:12px; font-size:1rem;
    background: rgba(0,0,0,0.25); color:var(--text); outline:none;
    box-shadow: inset 0 2px 8px rgba(0,0,0,.3);
  }
  button{
    background: var(--brand); color:#111; font-weight:800; letter-spacing:.02em;
    box-shadow: 0 8px 18px rgba(255,195,0,.4); cursor:pointer; text-transform:uppercase;
    transition: all .2s ease;
  }
  button:hover{ background:var(--brand2); box-shadow:0 12px 28px rgba(255,214,10,.6); transform: translateY(-2px); }
  button:disabled{ background:#8a8a8a; cursor:not-allowed; box-shadow:none; transform: none; }
  .btn-danger { background: var(--err); color: white; }
  .btn-danger:hover { background: #c82333; }

  .mono{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    background:rgba(0,0,0,0.3); padding:10px 12px; border-radius:12px;
    overflow-wrap:anywhere; word-break:break-word;
  }
  #status{
    min-height:28px; font-weight:700; color:var(--brand); text-shadow:0 0 8px var(--brand);
  }
  .muted{ color:var(--muted); font-size:.92rem; }
  .balances{
    display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap;
  }
  .pill{
    background:var(--card2); border:1px solid rgba(255,255,255,.1);
    padding:8px 12px; border-radius:999px; font-weight:700;
  }
  /* Hide/show sections */
  .hidden { display: none; }
</style>
</head>
<body>
  <div class="app">
    <h1>Laam DEX</h1>

    <!-- LOGIN / WALLET SECTION -->
    <div id="walletSection" class="card">
      <!-- Unlock Wallet View -->
      <div id="unlockView">
        <h3 style="margin:0 0 10px 0; color:var(--brand)">Unlock Your Wallet</h3>
        <label for="walletPassword">Password</label>
        <input id="walletPassword" type="password" placeholder="Enter your password" />
        <button id="unlockBtn" style="margin-top:10px;">Unlock</button>
        <p class="muted" style="margin-top:10px;">
          Forgot password? <a href="#" id="resetWalletLink">Reset and import new key</a>.
        </p>
      </div>

      <!-- Import Key View -->
      <div id="importView" class="hidden">
        <h3 style="margin:0 0 10px 0; color:var(--brand)">Import Account</h3>
        <label for="secretKey">Your Secret Key</label>
        <input id="secretKey" type="password" placeholder="Starts with S... Keep it safe!" />
        <label for="createPassword" style="margin-top:8px;">Create a Password</label>
        <input id="createPassword" type="password" placeholder="Min. 8 characters" />
        <div class="muted" style="font-size:0.8rem; margin-top:4px;">This password encrypts your key in this browser. We don't store it.</div>
        <button id="importBtn" style="margin-top:10px;">Import and Save</button>
      </div>
    </div>

    <!-- LOGGED IN USER INFO -->
    <div id="loggedInView" class="hidden">
      <div class="card">
        <div class="balances">
          <span class="pill">XLM: <span id="xlmBal">0.00</span></span>
          <span class="pill">Laam: <span id="laamBal">0.00</span></span>
        </div>
        <label style="margin-top:10px;">Your Public Key</label>
        <div id="pubKey" class="mono">-</div>
        <div style="display:flex; gap:10px; margin-top:10px; justify-content:center;">
            <button id="addTrustlineBtn">Add Laam Trustline</button>
            <button id="logoutBtn" class="btn-danger">Logout & Lock</button>
        </div>
      </div>

      <!-- TRADE PANELS -->
      <div class="card trade-panels grid-2">
        <!-- Buy Panel -->
        <div class="panel buy">
          <h3>Laam (Pay XLM)</h3>
          <label>Price (XLM per Laam)</label>
          <input id="buyPrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
          <label style="margin-top:8px;">Amount (Laam)</label>
          <input id="buyAmount" type="number" step="0.0000001" placeholder="e.g. 100" />
          <button id="btnPlaceBuy" style="margin-top:10px;">Place Buy Offer</button>
        </div>
        <!-- Sell Panel -->
        <div class="panel sell">
          <h3>Laam (Get XLM)</h3>
          <label>Price (XLM per Laam)</label>
          <input id="sellPrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
          <label style="margin-top:8px;">Amount (Laam)</label>
          <input id="sellAmount" type="number" step="0.0000001" placeholder="e.g. 100" />
          <button id="btnPlaceSell" style="margin-top:10px;">Place Sell Offer</button>
        </div>
      </div>
    </div>

    <!-- ORDERBOOK -->
    <div class="card">
      <h3 style="margin:0 0 10px 0; color:var(--brand)">Market Offers</h3>
      <div id="status" style="margin-bottom:10px;">Loading market...</div>
      <div class="grid-2">
        <div>
          <h4 style="margin:0 0 8px 0; color:var(--ok);">Buy Offers (Bids)</h4>
          <table>
            <thead><tr><th>Price (XLM/Laam)</th><th>Amount (Laam)</th><th>Total (XLM)</th></tr></thead>
            <tbody id="bidsBody"></tbody>
          </table>
        </div>
        <div>
          <h4 style="margin:0 0 8px 0; color:var(--err);">Sell Offers (Asks)</h4>
          <table>
            <thead><tr><th>Price (XLM/Laam)</th><th>Amount (Laam)</th><th>Total (XLM)</th></tr></thead>
            <tbody id="asksBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
// === Stellar & UI Setup ===
const server = new StellarSdk.Server('https://horizon.stellar.org');
const ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';
const LAAM  = new StellarSdk.Asset('Laam', ISSUER);
const XLM   = StellarSdk.Asset.native();

// --- Global State ---
let keypair = null;
let account = null;
let balTimer = null;

// --- UI Elements ---
const walletSection = document.getElementById('walletSection');
const unlockView = document.getElementById('unlockView');
const importView = document.getElementById('importView');
const loggedInView = document.getElementById('loggedInView');
const statusEl = document.getElementById('status');

// === Wallet & Encryption Logic ===
const ENCRYPTED_KEY_NAME = 'laam_dex_wallet';

// Encrypts a secret key with a password
function encryptKey(secretKey, password) {
  return CryptoJS.AES.encrypt(secretKey, password).toString();
}

// Decrypts a secret key with a password
function decryptKey(encryptedKey, password) {
  const bytes = CryptoJS.AES.decrypt(encryptedKey, password);
  return bytes.toString(CryptoJS.enc.Utf8);
}

// Check if a wallet exists in localStorage
function walletExists() {
  return !!localStorage.getItem(ENCRYPTED_KEY_NAME);
}

// --- UI Switching ---
function showView(view) {
  walletSection.style.display = 'block';
  loggedInView.style.display = 'none';
  unlockView.style.display = 'none';
  importView.style.display = 'none';

  if (view === 'unlock') unlockView.style.display = 'block';
  else if (view === 'import') importView.style.display = 'block';
  else if (view === 'loggedIn') {
    walletSection.style.display = 'none';
    loggedInView.style.display = 'block';
  }
}

// === Core App Functions ===
function setStatus(msg, type = 'ok') {
    statusEl.textContent = msg;
    if (type === 'err') statusEl.style.color = 'var(--err)';
    else if (type === 'warn') statusEl.style.color = 'var(--warn)';
    else statusEl.style.color = 'var(--brand)';
}

async function login(secret) {
    try {
        keypair = StellarSdk.Keypair.fromSecret(secret);
        account = await server.loadAccount(keypair.publicKey());
        
        document.getElementById('pubKey').textContent = keypair.publicKey();
        setStatus('Account loaded successfully.', 'ok');
        showView('loggedIn');
        
        await refreshBalances();
        if (balTimer) clearInterval(balTimer);
        balTimer = setInterval(refreshBalances, 10000);
    } catch (e) {
        keypair = null;
        account = null;
        setStatus('Error: Could not load account. Check your key.', 'err');
        showView(walletExists() ? 'unlock' : 'import');
    }
}

function logout() {
    keypair = null;
    account = null;
    if (balTimer) clearInterval(balTimer);
    document.getElementById('walletPassword').value = '';
    showView(walletExists() ? 'unlock' : 'import');
    setStatus('You have been logged out.');
}

async function refreshBalances() {
    if (!keypair) return;
    try {
        account = await server.loadAccount(keypair.publicKey());
        let xlm = 0, laam = 0;
        for (const b of account.balances) {
            if (b.asset_type === 'native') xlm = parseFloat(b.balance);
            if (b.asset_code === 'Laam' && b.asset_issuer === ISSUER) laam = parseFloat(b.balance);
        }
        document.getElementById('xlmBal').textContent = xlm.toFixed(2);
        document.getElementById('laamBal').textContent = laam.toFixed(2);
    } catch (e) {
        console.error('Balance refresh failed:', e);
        setStatus('Could not refresh balances.', 'warn');
    }
}

// === Event Listeners ===

// --- Wallet Listeners ---
document.getElementById('importBtn').addEventListener('click', () => {
    const secret = document.getElementById('secretKey').value.trim();
    const password = document.getElementById('createPassword').value;

    if (password.length < 8) {
        alert('Password must be at least 8 characters long.');
        return;
    }
    if (!StellarSdk.StrKey.isValidEd25519SecretSeed(secret)) {
        alert('Invalid Secret Key.');
        return;
    }

    const encryptedKey = encryptKey(secret, password);
    localStorage.setItem(ENCRYPTED_KEY_NAME, encryptedKey);
    
    document.getElementById('secretKey').value = '';
    document.getElementById('createPassword').value = '';
    
    login(secret);
});

document.getElementById('unlockBtn').addEventListener('click', () => {
    const password = document.getElementById('walletPassword').value;
    const encryptedKey = localStorage.getItem(ENCRYPTED_KEY_NAME);

    if (!password) {
        alert('Please enter your password.');
        return;
    }

    try {
        const secret = decryptKey(encryptedKey, password);
        if (!StellarSdk.StrKey.isValidEd25519SecretSeed(secret)) {
            throw new Error('Decryption failed or key is invalid');
        }
        login(secret);
    } catch (e) {
        setStatus('Wrong password or corrupted data.', 'err');
    }
});

document.getElementById('logoutBtn').addEventListener('click', logout);

document.getElementById('resetWalletLink').addEventListener('click', (e) => {
    e.preventDefault();
    if (confirm('Are you sure? This will remove your saved key from this browser. You will need your secret key to import it again.')) {
        localStorage.removeItem(ENCRYPTED_KEY_NAME);
        logout();
        showView('import');
        setStatus('Wallet reset. Please import your key.');
    }
});

// --- Trading and other listeners ---
document.getElementById('addTrustlineBtn').addEventListener('click', async () => {
    // (This function is the same as before, just ensure it uses the global `keypair` and `account` variables)
    if (!account || !keypair){ alert('Load your account first.'); return; }
    try{
      const exists = account.balances.some(b=> b.asset_code==='Laam' && b.asset_issuer===ISSUER);
      if (exists){ setStatus('Trustline already exists.'); return; }

      const fee = await server.fetchBaseFee();
      const tx = new StellarSdk.TransactionBuilder(account, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
        .addOperation(StellarSdk.Operation.changeTrust({ asset: LAAM, limit: '1000000000' }))
        .setTimeout(30)
        .build();
      tx.sign(keypair);
      const res = await server.submitTransaction(tx);
      setStatus('Trustline added. Tx: '+res.hash);
      await refreshBalances();
    }catch(e){ setStatus('Error (trustline): '+ (e?.message || e), 'err'); }
});

async function placeOffer(isBuy) {
    if (!account || !keypair) { alert('Please log in first.'); return; }
    const price = parseFloat(document.getElementById(isBuy ? 'buyPrice' : 'sellPrice').value);
    const amount = parseFloat(document.getElementById(isBuy ? 'buyAmount' : 'sellAmount').value);

    if (!(price > 0) || !(amount > 0)) { alert('Enter a valid price and amount.'); return; }

    try {
        const freshAccount = await server.loadAccount(keypair.publicKey());
        const fee = await server.fetchBaseFee();
        let operation;

        if (isBuy) { // Buy Laam, Sell XLM
            operation = StellarSdk.Operation.manageBuyOffer({
                selling: XLM,
                buying: LAAM,
                buyAmount: amount.toFixed(7),
                price: price.toString(), // Price of 1 unit of buying in terms of selling
            });
        } else { // Sell Laam, Buy XLM
            operation = StellarSdk.Operation.manageSellOffer({
                selling: LAAM,
                buying: XLM,
                amount: amount.toFixed(7),
                price: price.toString(), // Price of 1 unit of selling in terms of buying
            });
        }

        const tx = new StellarSdk.TransactionBuilder(freshAccount, { fee, networkPassphrase: StellarSdk.Networks.PUBLIC })
            .addOperation(operation)
            .setTimeout(30)
            .build();
        
        tx.sign(keypair);
        const res = await server.submitTransaction(tx);
        setStatus(`${isBuy ? 'Buy' : 'Sell'} offer placed successfully.`, 'ok');
        await refreshBalances();
        await loadOrderbook();
    } catch (e) {
        setStatus(`Error placing ${isBuy ? 'buy' : 'sell'} offer: ` + (e?.message || e), 'err');
    }
}

document.getElementById('btnPlaceBuy').addEventListener('click', () => placeOffer(true));
document.getElementById('btnPlaceSell').addEventListener('click', () => placeOffer(false));


// === Orderbook Display ===
function fmt(n, d=7){ const x = parseFloat(n); if(!isFinite(x)) return '-'; return x.toFixed(d); }

async function loadOrderbook(){
    try{
      const ob = await server.orderbook(LAAM, XLM).call();
      
      function rowHTML(price, amount){
        const total = price * amount;
        return `<tr><td>${fmt(price)}</td><td>${fmt(amount)}</td><td>${fmt(total)}</td></tr>`;
      }

      bidsBody.innerHTML = ob.bids.length
        ? ob.bids.map(b => rowHTML(parseFloat(b.price), parseFloat(b.amount))).join('')
        : `<tr><td colspan="3" class="muted">No buy offers</td></tr>`;

      asksBody.innerHTML = ob.asks.length
        ? ob.asks.map(a => rowHTML(parseFloat(a.price), parseFloat(a.amount))).join('')
        : `<tr><td colspan="3" class="muted">No sell offers</td></tr>`;
        
      setStatus('Market data loaded.', 'ok');
    }catch(e){
      console.error(e);
      setStatus('Error loading orderbook.', 'err');
    }
}

// === Initial Load ===
document.addEventListener('DOMContentLoaded', () => {
    if (walletExists()) {
        showView('unlock');
    } else {
        showView('import');
    }
    loadOrderbook(); // Load market data regardless of login state
});

</script>
</body>
  </html>
  
