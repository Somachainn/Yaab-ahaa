<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam Wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
:root{
  /* Blue & White theme */
  --bg1:#eef2f3; --bg2:#8e9eab;
  --card:#ffffff; --line:#d6e0ea; --soft:#f4f7fb;
  --text:#0a192f; --muted:#5f7383;
  --brand:#0052cc; --brand2:#0041a3; --ok:#28a745; --err:#dc3545;
  --rad:16px; --maxw:980px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  color:var(--text);
  background:linear-gradient(135deg,var(--bg1),var(--bg2));
  min-height:100vh; padding:24px 14px; display:flex; justify-content:center;
}
.app{width:100%; max-width:var(--maxw);}
h1{margin:0 0 14px; text-align:center; color:var(--brand); font-size:1.9rem; font-weight:800}
.card{background:var(--card); border:1px solid var(--line); border-radius:var(--rad); box-shadow:0 10px 30px rgba(0,0,0,.06); padding:18px; margin:12px 0;}
.row{margin:10px 0}
label{display:block; font-weight:700; color:var(--brand); margin-bottom:6px}
input,select,button{
  width:100%; padding:12px 14px; border:1px solid var(--line); border-radius:12px; background:#fbfdff; font-size:1rem;
}
input:focus,select:focus{outline:none; border-color:var(--brand)}
button{background:var(--brand); color:#fff; font-weight:800; letter-spacing:.02em; border:none; cursor:pointer; box-shadow:0 6px 16px rgba(0,82,204,.25); text-transform:uppercase}
button:hover{background:var(--brand2)}
.btn-row{display:grid; grid-template-columns:repeat(4,1fr); gap:10px}
@media (max-width:760px){ .btn-row{grid-template-columns:repeat(2,1fr)} }
.btn-secondary{background:#6c757d} .btn-secondary:hover{background:#5a6268}
.btn-danger{background:#dc3545} .btn-danger:hover{background:#c82333}
.pill{
  background:var(--soft); border:1px solid var(--line); border-radius:14px; padding:10px 14px; display:flex; align-items:center; gap:10px; font-weight:700
}
.portfolio{
  display:grid; grid-template-columns:1fr; gap:12px; align-items:stretch
}
.value-xl{font-size:1.6rem; font-weight:900}
.sub{color:var(--muted); font-size:.9rem}
.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#eef3f8; border:1px solid var(--line); padding:10px; border-radius:12px; word-break:break-word}
.table{width:100%; border-collapse:collapse}
.table th,.table td{padding:10px; border-bottom:1px solid var(--line); text-align:right}
.table th:first-child,.table td:first-child{text-align:left}
.badge{font-size:.78rem; padding:3px 8px; border-radius:999px; background:#e7f1ff; color:var(--brand); border:1px solid var(--line)}
.center{text-align:center}

/* Trade UI */
.trade-card{padding:0; overflow:hidden}
.trade-header{display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--line)}
.trade-header h3{margin:0; font-size:1.2rem}
.trade-header .icon{font-size:1.5rem; cursor:pointer}
.trade-asset-selector{display:flex; align-items:center; justify-content:space-between; padding:16px 20px; background:var(--soft)}
.asset-box{display:flex; align-items:center; gap:8px}
.asset-box img{width:24px; height:24px}
.asset-box div{text-align:left}
.asset-box .asset-name{font-weight:600}
.asset-box .asset-issuer{font-size:.8rem; color:var(--muted)}
.swap-icon{font-size:1.5rem; background:white; border-radius:50%; padding:5px; border:1px solid var(--line); cursor:pointer}
.trade-tabs{display:flex; border-bottom:1px solid var(--line)}
.trade-tabs .tab{flex:1; padding:12px; text-align:center; cursor:pointer; font-weight:600; color:var(--muted); border-bottom:3px solid transparent}
.trade-tabs .tab.active{color:var(--brand); border-bottom-color:var(--brand)}
.orderbook-content{padding:10px 20px 20px}
.orderbook-table{width:100%; border-collapse:collapse}
.orderbook-table th,.orderbook-table td{text-align:right; padding:8px 4px; font-size:.9rem}
.orderbook-table th{color:var(--muted); font-weight:normal}
.orderbook-table th:first-child,.orderbook-table td:first-child{text-align:left}
.orderbook-table .bid-row td:nth-child(2){color:var(--ok)}
.orderbook-table .ask-row td:nth-child(2){color:var(--err)}
.spread{padding:12px 0; text-align:center; font-weight:bold; border-top:1px solid var(--line); border-bottom:1px solid var(--line); margin:8px 0}
.trade-actions{display:flex; gap:15px; padding:20px; background:var(--soft); border-top:1px solid var(--line)}
.trade-actions button{flex:1; padding:14px; font-size:1.1rem; border-radius:12px; text-transform:uppercase}
.btn-buy{background-color:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,.3)}
.btn-buy:hover{background-color:#218838}
.btn-sell{background-color:var(--err); box-shadow:0 4px 14px rgba(220,53,69,.3)}
.btn-sell:hover{background-color:#c82333}

/* Modals */
.modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:1000}
.modal.show{display:grid}
.modal-card{background:var(--card); border:1px solid var(--line); border-radius:16px; padding:18px; width:min(520px,94vw); max-height:90vh; overflow:auto}
.modal-title{margin:0 0 8px; color:var(--brand)}
.close-x{background:none; border:none; font-size:1.6rem; color:var(--muted); cursor:pointer; float:right}
.flex{display:flex; gap:10px}
.copy{background:#eff6ff; color:var(--brand); border:1px solid var(--line)}
.small{font-size:.86rem}
.right{float:right}

/* Trade Modal Specifics */
.trade-modal-content{width:min(420px,94vw)}
.panel{background:var(--soft); border:1px solid var(--line); border-radius:12px; padding:20px; margin:0}
.titleRow{display:flex; justify-content:space-between; align-items:center; margin-bottom:20px}
.title{font-size:1.2rem; font-weight:700; color:var(--brand)}
.avail{font-size:.9rem; color:var(--muted)}
.field{margin-bottom:16px}
.inputWrap{position:relative; display:flex; align-items:center}
.inputWrap input{padding-right:60px; margin:0}
.unit{position:absolute; right:12px; color:var(--muted); font-weight:600; pointer-events:none}
.hint{font-size:.8rem; color:var(--muted); margin-top:4px; text-align:left}
.rowBtns{display:flex; gap:8px; margin-top:8px}
.rowBtns button{flex:1; padding:8px 12px; font-size:.9rem; background:#e9ecef; color:var(--text); border:1px solid var(--line); text-transform:none; font-weight:600}
.rowBtns button:hover{background:var(--brand); color:white; transform:none}
.totalBox{margin-bottom:20px}
.totalBox input{background:#e9ecef; color:var(--muted)}
.cta{padding:16px; font-size:1.1rem; font-weight:700; text-transform:uppercase; margin:0}
.cta.buy{background:var(--ok); box-shadow:0 4px 14px rgba(40,167,69,.3)}
.cta.buy:hover{background:#218838}
.cta.sell{background:var(--err)}
.cta.sell:hover{background:#c82333}
</style>
</head>
<body>
<div class="app">

  <h1>Laam Wallet</h1>

  <!-- AUTH -->
  <div id="authCard" class="card">
    <div id="firstView">
      <div class="row"><label>Secret Key (S…)</label><input id="sk" type="password" placeholder="SXXXXXXXXXXXXXXXXXXXXXXXX" /></div>
      <div class="row"><label>Create Password to Save</label><input id="pwd" type="password" placeholder="Min 8 chars" /></div>
      <div class="row"><button id="importBtn">Import and Save</button></div>
      <div class="row sub">Ama <a href="#" id="generateKey">Generate new Stellar account</a> (xasuuso: waa in aad ku shubtaa ugu yaraan 2 XLM si loo furo)</div>
      <div id="newKeys" class="row" style="display:none">
        <div class="row"><span class="badge">NEW SECRET</span><div id="newSecret" class="mono"></div></div>
        <div class="row"><span class="badge">NEW PUBLIC</span><div id="newPublic" class="mono"></div></div>
      </div>
    </div>

    <div id="unlockView" style="display:none">
      <div class="row"><label>Password</label><input id="unlockPwd" type="password" placeholder="••••••••" /></div>
      <div class="row"><button id="unlockBtn">Unlock</button></div>
      <div class="row sub"><a href="#" id="forgetWallet">Forget saved wallet</a></div>
    </div>
  </div>

  <!-- LOGGED IN -->
  <div id="walletView" style="display:none">

    <!-- Portfolio (Top) -->
    <div class="card">
      <div class="portfolio">
        <div class="pill">
          <div style="flex:1">
            <div class="sub">Portfolio Value</div>
            <div class="value-xl">$<span id="pfUsd">0.00</span></div>
            <div class="sub"><span id="pfBreak">XLM $0.00 + Laam $0.00</span></div>
          </div>
          <span class="badge">LIVE</span>
        </div>
      </div>
    </div>

    <!-- Middle buttons -->
    <div class="card">
      <div class="btn-row">
        <button id="btnSend">Send</button>
        <button id="btnReceive">Receive</button>
        <button id="btnTrust">Add Laam Trustline</button>
        <button id="btnLock" class="btn-danger">Lock Wallet</button>
      </div>
    </div>

    <!-- My Assets -->
    <div class="card">
      <div class="row" style="display:flex; justify-content:space-between; align-items:center">
        <h3 style="margin:0; color:var(--brand)">My Assets</h3>
        <span class="badge">Orderbook: <span id="obStatus">—</span></span>
      </div>
      <table class="table">
        <thead><tr><th>Asset</th><th>Balance</th><th>Price</th><th>Value (USD)</th></tr></thead>
        <tbody>
          <tr>
            <td>XLM</td>
            <td id="xlmBal">0.00</td>
            <td>$<span id="xlmUsdPrice">0.00</span></td>
            <td>$<span id="xlmUsdVal">0.00</span></td>
          </tr>
          <tr>
            <td>Laam</td>
            <td id="laamBal">0.00</td>
            <td><span id="laamPriceXLM">0.0000000</span> XLM ($<span id="laamUsdPrice">0.00</span>)</td>
            <td>$<span id="laamUsdVal">0.00</span></td>
          </tr>
        </tbody>
      </table>
      <div class="sub center">Prices update live. Laam price uses mid of best bid/ask on Stellar DEX.</div>
    </div>
    
    <!-- Trade UI -->
    <div class="card trade-card">
        <div class="trade-header">
            <h3>Trade</h3>
            <span class="icon" onclick="startRealtime()">↻</span>
        </div>
        <div class="trade-asset-selector">
            <div class="asset-box">
                <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam">
                <div>
                    <div class="asset-name">Laam</div>
                    <div class="asset-issuer">laam.online</div>
                </div>
            </div>
            <span class="swap-icon">⇄</span>
            <div class="asset-box">
                <img src="https://stellar.org/images/brand/stellar-logo-black.svg" alt="XLM" style="width:28px; height:28px;">
                <div>
                    <div class="asset-name">XLM</div>
                    <div class="asset-issuer">stellar.org</div>
                </div>
            </div>
        </div>
        <div class="trade-tabs">
            <div class="tab active" id="orderbookTab">Orderbook</div>
            <div class="tab" id="overviewTab">Overview</div>
            <div class="tab" id="lastTradesTab">Last Trades</div>
        </div>
        <div class="orderbook-content" id="orderbookContent">
            <table class="orderbook-table">
                <thead><tr><th>Amount (Laam)</th><th>Price (XLM)</th><th>Total (XLM)</th></tr></thead>
                <tbody id="asksBody"></tbody>
            </table>
            <div class="spread" id="spreadValue">-</div>
            <table class="orderbook-table">
                <tbody id="bidsBody"></tbody>
            </table>
        </div>
        <div id="overviewContent" style="display:none; padding: 20px;">[Overview Chart and Data Here]</div>
        <div id="lastTradesContent" style="display:none; padding: 20px;">[Last Trades History Here]</div>
        <div class="trade-actions">
            <button class="btn-buy" id="btnBuy">Buy</button>
            <button class="btn-sell" id="btnSell">Sell</button>
        </div>
    </div>
  </div>

  <!-- SEND MODAL -->
  <div id="sendModal" class="modal">
    <div class="modal-card">
      <button class="close-x" onclick="close(this.closest('.modal'))">&times;</button>
      <h3 class="modal-title">Send Asset</h3>
      <div class="row"><label>Asset</label>
        <select id="sendAsset"><option>XLM</option><option>Laam</option></select>
      </div>
      <div class="row"><label>Amount</label><input id="sendAmt" type="number" step="0.0000001" placeholder="e.g. 10" /></div>
      <div class="row"><label>Destination (G…)</label><input id="sendDst" type="text" placeholder="GXXXXXXXXXXXXXXXX" /></div>
      <div class="row"><button id="sendNow">Send Now</button></div>
    </div>
  </div>

  <!-- RECEIVE MODAL -->
  <div id="recvModal" class="modal">
    <div class="modal-card">
      <button class="close-x" onclick="close(this.closest('.modal'))">&times;</button>
      <h3 class="modal-title">Receive</h3>
      <div class="row sub">Share this public key to receive XLM or Laam</div>
      <div class="row"><div id="recvPub" class="mono"></div></div>
      <div class="row"><button id="copyRecv" class="copy">Copy Address</button></div>
    </div>
  </div>
  
  <!-- TRADE MODAL -->
  <div id="tradeModal" class="modal">
    <div class="modal-card trade-modal-content">
      <button class="close-x" onclick="close(this.closest('.modal'))">&times;</button>
      <div class="panel">
        <div class="titleRow">
          <div class="title" id="panelTitle">Buy Laam</div>
          <div class="avail">Available: <span id="availBalance">0</span></div>
        </div>
        <div class="field">
          <div class="inputWrap">
            <input id="modalPrice" type="number" step="0.0000001" placeholder="Price" />
            <div class="unit">XLM</div>
          </div>
          <div class="hint">Price (XLM per Laam)</div>
        </div>
        <div class="field">
          <div class="inputWrap">
            <input id="modalAmount" type="number" step="0.0000001" placeholder="Amount" />
            <div class="unit">Laam</div>
          </div>
          <div class="rowBtns">
            <button data-fill="25">25%</button><button data-fill="50">50%</button>
            <button data-fill="75">75%</button><button data-fill="100">100%</button>
          </div>
        </div>
        <div class="totalBox">
          <div class="inputWrap">
            <input id="modalTotal" type="number" step="0.0000001" placeholder="0.0000000" disabled />
            <div class="unit">XLM</div>
          </div>
          <div class="hint" id="totalHint">Total XLM you'll pay</div>
        </div>
        <button class="cta" id="modalConfirmBtn">Buy Laam</button>
      </div>
    </div>
  </div>

</div>

<script>
/* ==== CONFIG ==== */
const server = new StellarSdk.Server('https://horizon.stellar.org');
const ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';
const LAAM  = new StellarSdk.Asset('Laam', ISSUER);
const XLM   = StellarSdk.Asset.native();
const STORE = 'laam_wallet_enc_v1';

/* ==== STATE ==== */
let keypair = null, account = null;
let balancesTimer = null;
let paymentsStreamClose = null;
let obStreamClose = null;
let bestBid = null, bestAsk = null;
let currentTradeType = 'buy';

/* ==== HELPERS ==== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function fmt(n, d=2){return (Number(n)||0).toFixed(d)}
function encrypt(secret, pwd){return CryptoJS.AES.encrypt(secret, pwd).toString()}
function decrypt(enc, pwd){const b=CryptoJS.AES.decrypt(enc, pwd); return b.toString(CryptoJS.enc.Utf8)}
async function xlmUsd(){
  try{
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
    const j = await r.json(); return j?.stellar?.usd || 0;
  }catch{ return 0 }
}
function laamMid(){
  const bid = bestBid ? parseFloat(bestBid.price) : 0;
  const ask = bestAsk ? parseFloat(bestAsk.price) : 0;
  if(bid>0 && ask>0) return (bid+ask)/2;
  return ask || bid || 0;
}

/* ==== UI TOGGLES ==== */
function showLoggedIn(show){
  $('#authCard').style.display = show ? 'none' : 'block';
  $('#walletView').style.display = show ? 'block' : 'none';
}
const open = (el)=>el.classList.add('show');
const close = (el)=>el.classList.remove('show');

/* ==== AUTH ==== */
function walletExists(){ return !!localStorage.getItem(STORE) }
function goUnlock(){ $('#firstView').style.display='none'; $('#unlockView').style.display='block' }
function goFirst(){ $('#firstView').style.display='block'; $('#unlockView').style.display='none' }

$('#generateKey').addEventListener('click', e=>{
  e.preventDefault();
  const kp = StellarSdk.Keypair.random();
  $('#newSecret').textContent = kp.secret();
  $('#newPublic').textContent = kp.publicKey();
  $('#newKeys').style.display = 'block';
});

$('#importBtn').addEventListener('click', async ()=>{
  const secret = $('#sk').value.trim();
  const pwd = $('#pwd').value.trim();
  if(!secret || !pwd || pwd.length<8){ alert('Secret & strong password required.'); return }
  try{
    StellarSdk.Keypair.fromSecret(secret);
    localStorage.setItem(STORE, encrypt(secret, pwd));
    await login(secret);
  }catch{ alert('Invalid secret key') }
});

$('#unlockBtn').addEventListener('click', async ()=>{
  const pwd = $('#unlockPwd').value.trim();
  const enc = localStorage.getItem(STORE); if(!enc){ goFirst(); return }
  const secret = decrypt(enc, pwd);
  if(!secret){ alert('Wrong password'); return }
  await login(secret);
});

$('#forgetWallet').addEventListener('click', e=>{
  e.preventDefault();
  if(confirm('Forget saved wallet?')){ localStorage.removeItem(STORE); goFirst() }
});

/* ==== LOGIN / LOGOUT ==== */
async function login(secret){
  try{
    keypair = StellarSdk.Keypair.fromSecret(secret);
    account = await server.loadAccount(keypair.publicKey());
    $('#recvPub').textContent = keypair.publicKey();
    $('#copyRecv').onclick = ()=>navigator.clipboard.writeText(keypair.publicKey());
    showLoggedIn(true);
    startRealtime();
  }catch(e){
    alert(e?.response?.status===404 ? 'Account not found. Fund with 2 XLM to activate.' : 'Failed to load account');
    if(walletExists()) goUnlock(); else goFirst();
  }
}
function logout(){
  stopRealtime();
  keypair=null; account=null;
  $('#unlockPwd').value='';
  if(walletExists()) goUnlock(); else goFirst();
}
$('#btnLock').addEventListener('click', logout);

/* ==== REAL-TIME ==== */
function stopRealtime(){
  if(balancesTimer){ clearInterval(balancesTimer); balancesTimer=null }
  if(paymentsStreamClose){ paymentsStreamClose(); paymentsStreamClose=null }
  if(obStreamClose){ obStreamClose(); obStreamClose=null }
}
async function startRealtime(){
  stopRealtime(); // Stop any existing streams before starting new ones
  await refreshBalancesAndPrices(); // immediate
  balancesTimer = setInterval(refreshBalancesAndPrices, 15000);

  paymentsStreamClose = server.payments().forAccount(keypair.publicKey()).cursor('now')
    .stream({
      onmessage: ()=>refreshBalancesAndPrices(),
      onerror: (e)=>console.warn('payments stream error', e)
    });

  obStreamClose = server.orderbook(LAAM, XLM).stream({
    onmessage: (ob)=>{
      bestAsk = ob.asks?.[0] || null;
      bestBid = ob.bids?.[0] || null;
      updatePricesSection();
      updateOrderbookUI(ob.asks, ob.bids);
    },
    onerror: (e)=>console.warn('orderbook stream error', e)
  });
  $('#obStatus').textContent = 'LIVE';
}

/* ==== BALANCES + PRICES ==== */
async function refreshBalancesAndPrices(){
  if(!keypair) return;
  try{
    account = await server.loadAccount(keypair.publicKey());
    let xlm=0, laam=0;
    for(const b of account.balances){
      if(b.asset_type==='native') xlm=parseFloat(b.balance);
      if(b.asset_code==='Laam' && b.asset_issuer===ISSUER) laam=p
