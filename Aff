<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Laam DEX Wallet</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.4.0/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  :root{
    --teal:#0e8691; --teal2:#0b6f78;
    --bg:#f4f7fb; --card:#ffffff; --line:#e3e8ef;
    --text:#0a1f33; --muted:#6b7a8a; --ok:#28a745; --err:#dc3545;
    --brand:#0052cc;
    --rad:16px; --shadow:0 10px 28px rgba(15,23,42,.10);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .wrap{max-width:920px;margin:0 auto;padding:14px}
  .hidden{display:none}

  /* ===== TOP PORTFOLIO BAR ===== */
  .portfolio{
    background:var(--teal); color:#fff; border-radius:24px;
    padding:26px 18px 18px; box-shadow:var(--shadow);
  }
  .port-head{ display:flex; justify-content:space-between; align-items:center; opacity:.92; font-weight:600; }
  .port-main{ text-align:center; margin:10px 0 6px; }
  .port-value{ font-size:3rem; font-weight:900; letter-spacing:.5px; }
  .port-delta{ display:flex; gap:8px; justify-content:center; margin-top:6px; }
  .chip{ background:rgba(255,255,255,.14); padding:6px 10px; border-radius:999px; font-weight:700; }
  .eye{ cursor:pointer; user-select:none; }

  /* ===== ACTION BUTTONS ===== */
  .actions{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-top:18px; }
  @media (max-width:720px){ .actions{ grid-template-columns:repeat(2,1fr);} }
  .act{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:12px 10px; text-align:center; box-shadow:var(--shadow); }
  .act-circle{ width:64px;height:64px;border-radius:50%;margin:0 auto 8px; display:grid;place-items:center; background:#eaf0f6; border:1px solid var(--line); font-size:26px; }
  .act label{ display:block; font-weight:800; margin-top:2px; }
  .act small{ color:var(--muted) }

  /* ===== CARD ===== */
  .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--rad); box-shadow:var(--shadow); padding:16px; margin-top:14px; }

  /* ===== MY ASSETS ===== */
  .assets h3{ margin:6px 0 10px; }
  .asset-row{ display:flex; align-items:center; justify-content:space-between; padding:12px 8px; border-bottom:1px dashed var(--line); }
  .asset-left{ display:flex; align-items:center; gap:12px; }
  .icon{ width:42px;height:42px;border-radius:50%; background:#eef2f6; display:grid; place-items:center; font-size:22px; }
  .aname{ font-weight:800; }
  .aissuer{ font-size:.9rem; color:var(--muted); }
  .aval{ text-align:right; }
  .aval .amt{ font-weight:800; }
  .aval .usd{ color:var(--muted); font-size:.9rem; }

  /* ===== Misc ===== */
  .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
  input,button,select{font-size:1rem}
  button{cursor:pointer}
  .btn{ padding:12px 14px; border-radius:12px; border:1px solid var(--line); background:#f5f7fb; }
  .btn.primary{ background:#0ea5e9; color:#fff; border:none }
</style>
</head>
<body>
<div class="wrap">

  <!-- AUTH PANELS (iscisiya sidii hore) -->
  <div id="authSection">
    <div class="card">
      <div id="initialView">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div>
            <h3 style="margin:0;color:var(--brand)">New User?</h3>
            <button id="showCreateWalletBtn" class="btn">Create New Wallet</button>
            <div id="createWalletForm" class="hidden" style="margin-top:10px;">
              <button id="generateAccountBtn" class="btn">Generate New Stellar Account</button>
              <label style="display:block;margin-top:10px;">New Secret Key</label>
              <div id="newSecret" class="mono">-</div>
              <label style="display:block;margin-top:10px;">New Public Key</label>
              <div id="newPublic" class="mono">-</div>
              <div style="color:var(--muted);margin-top:6px;">Save your secret key securely; fund ‚â• 2 XLM to activate.</div>
            </div>
          </div>
          <div>
            <h3 style="margin:0;color:var(--brand)">Have a Wallet?</h3>
            <label>Secret Key</label>
            <input id="secretKeyInput" type="password" placeholder="S..." style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px" />
            <label style="display:block;margin-top:10px;">Create Password</label>
            <input id="savePasswordInput" type="password" placeholder="Min 8 chars" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px" />
            <button id="importAndSaveBtn" class="btn primary" style="margin-top:10px;">Import and Save</button>
          </div>
        </div>
      </div>

      <div id="unlockView" class="hidden">
        <h3 style="margin:0;color:var(--brand)">Unlock Wallet</h3>
        <label>Password</label>
        <input id="walletPassword" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px" />
        <button id="unlockBtn" class="btn primary" style="margin-top:10px;">Unlock</button>
        <p style="margin:8px 0 0;"><a href="#" id="resetWalletLink">Reset and Import New Key</a></p>
      </div>
    </div>
  </div>

  <!-- LOGGED IN VIEW -->
  <div id="loggedInView" class="hidden">
    <!-- TOP: Portfolio -->
    <div class="portfolio">
      <div class="port-head">
        <span>Estimated portfolio value</span>
        <span class="eye" id="eyeToggle">üëÅÔ∏è</span>
      </div>
      <div class="port-main">
        <div class="port-value" id="portUsd">$0.00</div>
        <div class="port-delta">
          <span class="chip" id="portDeltaAmt">-$0.00</span>
          <span class="chip" id="portDeltaPct">‚ñº 0.00%</span>
        </div>
      </div>

      <!-- MIDDLE: buttons -->
      <div class="actions">
        <div class="act">
          <div class="act-circle">‚Üó</div>
          <button class="btn primary" id="btnSendToggle" style="width:100%">Send</button>
          <small></small>
        </div>
        <div class="act">
          <div class="act-circle">‚Üò</div>
          <button class="btn" id="btnReceive" style="width:100%">Receive</button>
        </div>
        <div class="act">
          <div class="act-circle">Ôºã</div>
          <button class="btn" id="addTrustlineBtn" style="width:100%">Add Laam Trustline</button>
        </div>
        <div class="act">
          <div class="act-circle">üîí</div>
          <button class="btn" id="logoutBtn" style="width:100%">Lock Wallet</button>
        </div>
      </div>

      <!-- Send collapse -->
      <div id="sendForm" class="card" style="margin-top:14px;display:none;background:#0f94a0;border-color:#138996;color:#fff">
        <h4 style="margin:0 0 8px">Send Assets</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <div>
            <label>Asset</label>
            <select id="sendAsset" style="width:100%;padding:10px;border-radius:10px">
              <option value="XLM">XLM</option>
              <option value="LAAM">Laam</option>
            </select>
          </div>
          <div>
            <label>Amount</label>
            <input id="sendAmount" type="number" step="0.0000001" placeholder="e.g. 10" style="width:100%;padding:10px;border-radius:10px" />
          </div>
        </div>
        <label style="display:block;margin-top:8px;">Destination (G‚Ä¶)</label>
        <input id="sendDest" type="text" style="width:100%;padding:10px;border-radius:10px" />
        <button id="btnSend" class="btn" style="margin-top:10px;background:#fff;">Send Now</button>
      </div>
    </div>

    <!-- BOTTOM: My assets -->
    <div class="card assets">
      <h3>My assets</h3>

      <div class="asset-row">
        <div class="asset-left">
          <div class="icon">‚ìà</div>
          <div>
            <div class="aname">Lumens</div>
            <div class="aissuer">XLM (stellar.org)</div>
          </div>
        </div>
        <div class="aval">
          <div class="amt"><span id="xlmBal">0.00</span> XLM</div>
          <div class="usd">$<span id="xlmUsd">0.00</span></div>
        </div>
      </div>

      <div class="asset-row">
        <div class="asset-left">
          <div class="icon">‚ñ≥</div>
          <div>
            <div class="aname">Laam</div>
            <div class="aissuer">Laam (laam.online)</div>
          </div>
        </div>
        <div class="aval">
          <div class="amt"><span id="laamBal">0.00</span> Laam</div>
          <div class="usd">$<span id="laamUsd">0.00</span></div>
        </div>
      </div>

      <label style="display:block;margin-top:12px;">Your Public Key</label>
      <div id="pubKey" class="mono" style="overflow-wrap:anywhere;background:#f1f5f9;border:1px solid var(--line);padding:10px;border-radius:10px">-</div>
    </div>
  </div>

  <!-- Receive Modal -->
  <div id="receiveModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:grid;place-items:center;z-index:10;">
    <div class="card" style="max-width:420px;width:92%;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Receive</h3>
        <button class="btn" onclick="toggleReceive(false)">‚úï</button>
      </div>
      <div class="mono" id="recvAddress" style="margin:10px 0">-</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="copyAddr" class="btn">Copy</button>
        <a id="qrLink" target="_blank" rel="noopener" class="btn">Open QR</a>
      </div>
      <img id="qrImg" alt="QR" style="width:200px;height:200px;border-radius:12px;border:1px solid var(--line);margin-top:8px" />
    </div>
  </div>

</div>

<script>
/* ========= Stellar / App State ========= */
const server = new StellarSdk.Server('https://horizon.stellar.org');
const ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';
const ASSET_LAAM = new StellarSdk.Asset('Laam', ISSUER);
const ASSET_XLM  = StellarSdk.Asset.native();
const KEY_SLOT = 'laam_dex_wallet_v4';
let keypair=null, account=null, asks=[], bids=[], hideValues=false;

/* ========= Helpers ========= */
const $ = sel => document.querySelector(sel);
function walletExists(){ return !!localStorage.getItem(KEY_SLOT); }
function encrypt(sk,pw){ return CryptoJS.AES.encrypt(sk,pw).toString(); }
function decrypt(ct,pw){ return CryptoJS.AES.decrypt(ct,pw).toString(CryptoJS.enc.Utf8); }

/* ========= Auth ========= */
async function login(secret){
  try{
    keypair = StellarSdk.Keypair.fromSecret(secret);
    account = await server.loadAccount(keypair.publicKey());
    $('#pubKey').textContent = keypair.publicKey();
    $('#authSection').classList.add('hidden');
    $('#loggedInView').classList.remove('hidden');
    await Promise.all([loadOrderbook(), refreshBalances()]);
  }catch(e){
    alert(e.message.includes('404')?'Account not found. Fund ‚â• 2 XLM.':'Could not load account.');
    $('#authSection').classList.remove('hidden');
    $('#loggedInView').classList.add('hidden');
  }
}
function logout(){
  keypair=null; account=null;
  $('#loggedInView').classList.add('hidden');
  $('#authSection').classList.remove('hidden');
}

/* ========= Prices & Portfolio ========= */
async function fetchXlmUsd(){
  try{
    const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
    const d=await r.json(); return d.stellar.usd;
  }catch{ return 0; }
}
async function loadOrderbook(){
  try{
    const ob = await server.orderbook(ASSET_LAAM, ASSET_XLM).call();
    asks=ob.asks; bids=ob.bids;
  }catch(e){ asks=bids=[]; }
}
function laamPriceXLM(){
  if(asks.length) return parseFloat(asks[0].price);
  if(bids.length) return 1/parseFloat(bids[0].price);
  return 0;
}
async function refreshBalances(){
  if(!keypair) return;
  account=await server.loadAccount(keypair.publicKey());
  let xlm=0, laam=0;
  for(const b of account.balances){
    if(b.asset_type==='native') xlm=parseFloat(b.balance);
    if(b.asset_code==='Laam' && b.asset_issuer===ISSUER) laam=parseFloat(b.balance);
  }
  const xlmUsd = await fetchXlmUsd();
  const laamPx = laamPriceXLM();
  const laamUsd = laamPx * xlmUsd;

  // set asset rows
  $('#xlmBal').textContent=xlm.toFixed(2);
  $('#laamBal').textContent=laam.toFixed(2);
  $('#xlmUsd').textContent=(xlm*xlmUsd).toFixed(2);
  $('#laamUsd').textContent=(laam*laamUsd).toFixed(2);

  // portfolio (simple delta mock vs 24h -0.4%)
  const totalUsd = (xlm*xlmUsd) + (laam*laamUsd);
  const deltaPct = -0.40; // demo ‚Äì haddii aad rabto waan ka dhigi karnaa real, hadda waa style la mid ah sawirka
  const deltaAmt = totalUsd * (deltaPct/100);
  $('#portUsd').textContent = hideValues ? '‚Ä¢‚Ä¢‚Ä¢' : ('$'+totalUsd.toFixed(2));
  $('#portDeltaAmt').textContent = (deltaAmt<0?'-':'+')+'$'+Math.abs(deltaAmt).toFixed(2);
  $('#portDeltaPct').textContent = (deltaPct<0?'‚ñº ':'‚ñ≤ ')+Math.abs(deltaPct).toFixed(2)+'%';
}

/* ========= Receive modal ========= */
function toggleReceive(show=true){
  const m = $('#receiveModal');
  if(show){
    const addr = keypair?.publicKey() || $('#pubKey').textContent;
    $('#recvAddress').textContent = addr;
    const url=`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(addr)}`;
    $('#qrImg').src=url; $('#qrLink').href=url;
    m.classList.remove('hidden');
  }else m.classList.add('hidden');
}

/* ========= Events ========= */
$('#showCreateWalletBtn').onclick=()=>{ document.getElementById('createWalletForm').classList.remove('hidden'); $('#showCreateWalletBtn').classList.add('hidden'); };
$('#generateAccountBtn').onclick=()=>{ const p=StellarSdk.Keypair.random(); $('#newSecret').textContent=p.secret(); $('#newPublic').textContent=p.publicKey(); };
$('#importAndSaveBtn').onclick=async ()=>{
  const sk=$('#secretKeyInput').value.trim(), pw=$('#savePasswordInput').value;
  if(!sk||!pw) return alert('Enter secret & password'); if(pw.length<8) return alert('Password too short');
  try{ StellarSdk.Keypair.fromSecret(sk); localStorage.setItem(KEY_SLOT, encrypt(sk,pw)); await login(sk); }catch{ alert('Invalid secret'); }
};
$('#unlockBtn').onclick=async ()=>{
  const enc=localStorage.getItem(KEY_SLOT), pw=$('#walletPassword').value;
  try{ const sk=decrypt(enc,pw); await login(sk); }catch{ alert('Wrong password'); }
};
$('#resetWalletLink').onclick=(e)=>{ e.preventDefault(); if(confirm('Delete saved wallet?')){ localStorage.removeItem(KEY_SLOT); location.reload(); }};

$('#btnSendToggle').onclick=()=>{ const s=document.getElementById('sendForm'); s.style.display = s.style.display==='none'||!s.style.display ? 'block':'none'; };
$('#btnReceive').onclick=()=>toggleReceive(true);
$('#copyAddr').onclick=async ()=>{ await navigator.clipboard.writeText($('#recvAddress').textContent); alert('Copied'); };
$('#logoutBtn').onclick=logout;
$('#addTrustlineBtn').onclick=async ()=>{
  if(!keypair||!account) return alert('Login first');
  try{
    const tx=new StellarSdk.TransactionBuilder(account,{fee:StellarSdk.BASE_FEE,networkPassphrase:StellarSdk.Networks.PUBLIC})
      .addOperation(StellarSdk.Operation.changeTrust({asset:ASSET_LAAM}))
      .setTimeout(30).build();
    tx.sign(keypair); await server.submitTransaction(tx);
    alert('Trustline added'); await refreshBalances();
  }catch(e){ alert('Failed: '+e.message); }
};
$('#btnSend').onclick=async ()=>{
  if(!keypair||!account) return alert('Login first');
  const asset=document.getElementById('sendAsset').value, amount=document.getElementById('sendAmount').value, dest=document.getElementById('sendDest').value;
  if(!amount||!dest) return alert('Fill all fields');
  try{
    const tb=new StellarSdk.TransactionBuilder(account,{fee:StellarSdk.BASE_FEE,networkPassphrase:StellarSdk.Networks.PUBLIC})
      .addOperation(StellarSdk.Operation.payment({ destination:dest, asset: asset==='XLM'?ASSET_XLM:ASSET_LAAM, amount }))
      .setTimeout(30).build();
    tb.sign(keypair); await server.submitTransaction(t b);
  }catch{}
};
document.getElementById('btnSend').onclick=async ()=>{
  if(!keypair||!account) return alert('Login first');
  const asset=document.getElementById('sendAsset').value, amount=document.getElementById('sendAmount').value, dest=document.getElementById('sendDest').value;
  if(!amount||!dest) return alert('Fill all fields');
  try{
    const txb=new StellarSdk.TransactionBuilder(account,{fee:StellarSdk.BASE_FEE,networkPassphrase:StellarSdk.Networks.PUBLIC});
    txb.addOperation(StellarSdk.Operation.payment({
      destination:dest, asset: asset==='XLM'?ASSET_XLM:ASSET_LAAM, amount
    }));
    const tx=txb.setTimeout(30).build(); tx.sign(keypair); await server.submitTransaction(tx);
    alert('Payment sent'); document.getElementById('sendAmount').value=''; document.getElementById('sendDest').value='';
    document.getElementById('sendForm').style.display='none'; await refreshBalances();
  }catch(e){ alert('Send failed: '+e.message); }
};
$('#eyeToggle').onclick=()=>{ hideValues=!hideValues; refreshBalances(); };
document.addEventListener('DOMContentLoaded', async ()=>{
  if(walletExists()){ document.getElementById('unlockView').classList.remove('hidden'); }
  await loadOrderbook();
  // Haddii userku markiiba unlock sameeyo, values way buuxsamayaan
});
</script>
</body>
            </html>
            
